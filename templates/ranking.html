<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ë§›ì§‘ ë­í‚¹</title>

    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/form-style.css') }}"
    />
    <style>
      .pagination {
        text-align: center;
        margin-top: 18px;
      }

      .pagination a {
        margin: 0 4px;
        padding: 6px 10px;
        color: #1a73e8;
        text-decoration: none;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
      }

      .pagination a:hover {
        background-color: #e8f0fe;
      }

      .pagination .active {
        background-color: #1a73e8;
        color: white;
        font-weight: bold;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="top-nav">
      <div class="nav-left">
        <div class="form-icon">
          <strong>ğŸ½ï¸</strong>
        </div>
        <div class="form-title-group">
          <div class="form-title-text">ë§›ì§‘ ë­í‚¹</div>
        </div>
      </div>

      <div class="nav-center"></div>

      <div class="nav-right">
        <button class="publish-btn" id="refresh-btn">ë­í‚¹ ìƒˆë¡œê³ ì¹¨</button>
        <button class="more-btn">â‹®</button>
        <button class="publish-btn" id="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
    <div class="main-content">
      <div class="tab-menu">
        <button class="tab-btn active">ë­í‚¹</button>
        <button class="tab-btn" id="inquiry-tab">ë¬¸ì˜</button>
      </div>
      <div class="form-container">
        <div class="form-card">
          <div class="form-header">
            <input
              class="form-title-input"
              type="text"
              value="ë§›ì§‘ ë­í‚¹ ê²°ê³¼"
              readonly
            />
            <div class="form-description">
              <input
                class="form-description-input"
                type="text"
                value="ì‚¬ìš©ì ë¦¬ë·°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚°ëœ ë² ì´ì§€ì•ˆ ì ìˆ˜ ìˆœ ë­í‚¹ì…ë‹ˆë‹¤."
                readonly
              />
            </div>
          </div>
        </div>

        <div id="rank-list"></div>
        <div id="pagination"></div>

        <div id="rank-loading" style="margin-top: 12px; color: #5f6368">
          ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
        </div>
        <div
          id="rank-error"
          style="margin-top: 12px; color: #d93025; display: none"
        >
          ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
        </div>
      </div>
    </div>

    <script>
      const PAGE_SIZE = 20;
      let currentPage = 1;
      let totalPages = 1;

      const rankListEl = document.getElementById("rank-list");
      const loadingEl = document.getElementById("rank-loading");
      const errorEl = document.getElementById("rank-error");

      async function loadTotalCount() {
        const res = await fetch("/api/rank/count");
        const data = await res.json();
        totalPages = Math.ceil(data.count / PAGE_SIZE);
      }

      async function loadRanking(page = 1) {
        currentPage = page;
        const offset = (page - 1) * PAGE_SIZE;
        const API_URL = `/api/rank?limit=${PAGE_SIZE}&offset=${offset}&use_adv=1`;

        loadingEl.style.display = "block";
        errorEl.style.display = "none";
        rankListEl.innerHTML = "";

        try {
          const res = await fetch(API_URL);
          const data = await res.json();
          loadingEl.style.display = "none";

          if (!Array.isArray(data) || data.length === 0) {
            rankListEl.innerHTML =
              '<div style="margin-top: 8px; color:#5f6368;">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
          }

          data.forEach((store, index) => {
            const card = document.createElement("div");
            card.className = "question-card";
            const globalRank = (page - 1) * PAGE_SIZE + (index + 1);

            card.innerHTML = `
            <div class="question-content">
              <div class="question-header">
                <div class="question-title-input" style="border-bottom:none;">
                  ${globalRank}ìœ„ Â· ${store.name}
                </div>
              </div>
              <div class="question-options">
                <div class="option-item">í‰ê·  í‰ì : <strong>${Number(
                  store.avg_rating
                ).toFixed(2)}</strong></div>
                <div class="option-item">ë¦¬ë·° ìˆ˜: <strong>${
                  store.review_cnt
                }</strong>ê°œ</div>
                <div class="option-item">ì ìˆ˜: <strong>${Number(
                  store.score
                ).toFixed(3)}</strong></div>
                <div class="option-item">ê±°ë¦¬: <strong>${
                  store.distance_km
                }</strong> km</div>
                <div class="option-item">
                  <button class="publish-btn" onclick="location.href='/ranking/store_info/${
                    store.store_id
                  }'">
                    ë©”ë‰´ / ìƒì„¸ ë³´ê¸°
                  </button>
                </div>
              </div>
            </div>
          `;
            rankListEl.appendChild(card);
          });

          renderPagination();
        } catch (err) {
          loadingEl.style.display = "none";
          errorEl.style.display = "block";
        }
      }

      function renderPagination() {
        const paginationEl = document.getElementById("pagination");
        let html = `<div class="pagination">`;

        for (let i = 1; i <= totalPages; i++) {
          if (i === currentPage) {
            html += `<a class="active">${i}</a>`;
          } else {
            html += `<a onclick="loadRanking(${i})">${i}</a>`;
          }
        }

        html += `</div>`;

        paginationEl.innerHTML = html;
      }

      (async () => {
        await loadTotalCount();
        loadRanking(1);
      })();
      document.getElementById("refresh-btn").addEventListener("click", () => {
        currentPage = 1;
        loadRanking(1);
      });
      document.getElementById("inquiry-tab").addEventListener("click", () => {
        window.location.href = "inquiry";
      });

      function logout() {
        if (confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          localStorage.removeItem("token");
          localStorage.removeItem("user_id");
          localStorage.removeItem("user_name");
          localStorage.removeItem("isAdmin");
          localStorage.removeItem("adminId");
          localStorage.removeItem("admin_name");
          localStorage.removeItem("adminName");
          localStorage.removeItem("adminName");
          window.location.href = "/login";
        }
      }

      document.getElementById("logout-btn").addEventListener("click", logout);
    </script>
  </body>
</html>
